<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Input Piket Ujian AL-IRTS</title>
<style>
:root{
  --primary:#1a365d;
  --primary-light:#2d4a7c;
  --accent:#3b82f6;
  --accent-hover:#2563eb;
  --success:#10b981;
  --danger:#ef4444;
  --warning:#f59e0b;
  --bg-gradient-1:#f8fafc;
  --bg-gradient-2:#e2e8f0;
  --text:#1e293b;
  --text-light:#64748b;
  --border:#cbd5e1;
  --shadow:rgba(15,23,42,.08);
  --shadow-hover:rgba(15,23,42,.12);
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
}

body{
  font-family:'Segoe UI',system-ui,-apple-system,sans-serif;
  background:linear-gradient(135deg,var(--bg-gradient-1),var(--bg-gradient-2));
  min-height:100vh;
  padding:20px;
  color:var(--text);
  line-height:1.6;
}

.container{
  max-width:900px;
  margin:0 auto;
}

/* ===== HEADER ===== */
.header{
  text-align:center;
  margin-bottom:32px;
  animation:fadeInDown .6s ease;
}

.header h1{
  color:var(--primary);
  font-size:28px;
  font-weight:700;
  margin-bottom:8px;
  letter-spacing:-.5px;
}

.header p{
  color:var(--text-light);
  font-size:15px;
}

/* ===== CARD ===== */
.card{
  background:#fff;
  border-radius:16px;
  padding:24px;
  margin-bottom:20px;
  box-shadow:0 4px 20px var(--shadow);
  transition:transform .2s,box-shadow .2s;
  animation:fadeInUp .6s ease;
}

.card:hover{
  box-shadow:0 8px 30px var(--shadow-hover);
}

.card-title{
  color:var(--primary);
  font-size:18px;
  font-weight:600;
  margin-bottom:16px;
  display:flex;
  align-items:center;
  gap:8px;
}

.card-title::before{
  content:'';
  width:4px;
  height:20px;
  background:var(--accent);
  border-radius:2px;
}

/* ===== FORM ELEMENTS ===== */
.form-group{
  margin-bottom:20px;
}

label{
  display:block;
  font-weight:600;
  font-size:14px;
  color:var(--text);
  margin-bottom:8px;
}

label .required{
  color:var(--danger);
  margin-left:2px;
}

select,textarea,input[type="text"]{
  width:100%;
  padding:12px 16px;
  border:2px solid var(--border);
  border-radius:12px;
  font-size:15px;
  font-family:inherit;
  background:#fff;
  color:var(--text);
  transition:all .2s;
}

select:focus,textarea:focus,input:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(59,130,246,.1);
}

select:disabled,textarea:disabled,input:disabled{
  background:#f1f5f9;
  cursor:not-allowed;
  opacity:.6;
}

textarea{
  min-height:100px;
  resize:vertical;
  font-size:14px;
}

/* ===== CUSTOM SEARCHABLE SELECT ===== */
.select-wrapper{
  position:relative;
}

.select-search{
  position:relative;
  width:100%;
}

.select-search input{
  padding-right:40px;
}

.select-search-icon{
  position:absolute;
  right:14px;
  top:50%;
  transform:translateY(-50%);
  color:var(--text-light);
  pointer-events:none;
}

.select-dropdown{
  position:absolute;
  top:calc(100% + 4px);
  left:0;
  right:0;
  max-height:240px;
  overflow-y:auto;
  background:#fff;
  border:2px solid var(--border);
  border-radius:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.12);
  z-index:100;
  display:none;
}

.select-dropdown.show{
  display:block;
  animation:dropdownSlide .2s ease;
}

.select-option{
  padding:12px 16px;
  cursor:pointer;
  transition:background .15s;
  border-bottom:1px solid #f1f5f9;
}

.select-option:last-child{
  border-bottom:none;
}

.select-option:hover{
  background:#f8fafc;
}

.select-option.selected{
  background:#dbeafe;
  color:var(--accent);
  font-weight:600;
}

.select-option-empty{
  padding:20px;
  text-align:center;
  color:var(--text-light);
  font-size:14px;
}

@keyframes dropdownSlide{
  from{
    opacity:0;
    transform:translateY(-8px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* ===== BUTTONS ===== */
.btn{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:12px 24px;
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:600;
  cursor:pointer;
  transition:all .2s;
  font-family:inherit;
}

.btn:disabled{
  opacity:.5;
  cursor:not-allowed;
}

.btn-primary{
  background:var(--primary);
  color:#fff;
  box-shadow:0 4px 12px rgba(26,54,93,.2);
}

.btn-primary:hover:not(:disabled){
  background:var(--primary-light);
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(26,54,93,.3);
}

.btn-secondary{
  background:#f1f5f9;
  color:var(--accent);
  border:2px solid #e2e8f0;
}

.btn-secondary:hover:not(:disabled){
  background:#e2e8f0;
  border-color:#cbd5e1;
}

.btn-add{
  width:100%;
  margin-top:12px;
}

.btn-submit{
  width:100%;
  padding:16px;
  font-size:16px;
}

.btn-remove{
  padding:6px 12px;
  font-size:13px;
  background:#fee2e2;
  color:var(--danger);
  border:1px solid #fecaca;
  margin-left:8px;
  flex-shrink:0;
}

.btn-remove:hover:not(:disabled){
  background:#fecaca;
}

/* ===== PIKET GRID ===== */
.piket-grid{
  display:grid;
  gap:20px;
}

.piket-section{
  background:#f8fafc;
  padding:20px;
  border-radius:12px;
  border:2px dashed var(--border);
}

.piket-section-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:16px;
}

.piket-section h3{
  color:var(--primary);
  font-size:16px;
  font-weight:600;
}

.badge{
  background:var(--accent);
  color:#fff;
  padding:4px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
}

.guru-item{
  display:flex;
  align-items:flex-start;
  margin-bottom:12px;
  animation:fadeIn .3s ease;
  gap:8px;
}

.guru-item .select-wrapper{
  flex:1;
}

.empty-state{
  text-align:center;
  padding:32px 16px;
  color:var(--text-light);
  font-size:14px;
}

/* ===== RADIO TABS ===== */
.radio-tabs{
  display:flex;
  gap:12px;
  margin-bottom:16px;
}

.radio-tab{
  flex:1;
}

.radio-tab input{
  display:none;
}

.radio-tab label{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:12px 16px;
  background:#f1f5f9;
  border:2px solid #e2e8f0;
  border-radius:10px;
  cursor:pointer;
  transition:all .2s;
  font-weight:600;
  font-size:14px;
  text-align:center;
  min-height:60px;
}

.radio-tab input:checked + label{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
  box-shadow:0 4px 12px rgba(59,130,246,.3);
}

.radio-tab label:hover{
  border-color:#cbd5e1;
}

/* ===== LOADING ===== */
.loading-overlay{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.95);
  backdrop-filter:blur(4px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  animation:fadeIn .2s ease;
}

.loading-content{
  text-align:center;
  background:#fff;
  padding:32px;
  border-radius:20px;
  box-shadow:0 20px 60px rgba(0,0,0,.15);
  max-width:320px;
}

.spinner{
  width:50px;
  height:50px;
  border:4px solid #e2e8f0;
  border-top-color:var(--accent);
  border-radius:50%;
  margin:0 auto 16px;
  animation:spin 1s linear infinite;
}

.loading-content p{
  color:var(--text);
  font-size:15px;
  font-weight:500;
}

/* ===== ALERT ===== */
.alert{
  padding:16px 20px;
  border-radius:12px;
  margin-bottom:20px;
  font-size:14px;
  display:flex;
  align-items:center;
  gap:12px;
  animation:fadeInDown .4s ease;
}

.alert-info{
  background:#dbeafe;
  color:#1e40af;
  border:2px solid #93c5fd;
}

.alert-warning{
  background:#fef3c7;
  color:#92400e;
  border:2px solid #fcd34d;
}

.alert-error{
  background:#fee2e2;
  color:#991b1b;
  border:2px solid #fecaca;
}

/* ===== CONFIG SECTION ===== */
.config-section{
  background:#fef3c7;
  border:2px solid #fbbf24;
  padding:20px;
  border-radius:12px;
  margin-bottom:20px;
}

.config-section h3{
  color:#92400e;
  font-size:16px;
  margin-bottom:12px;
}

.config-section input{
  font-family:monospace;
  font-size:13px;
}

.config-section .btn{
  margin-top:12px;
  width:100%;
}

/* Closed submission notification */
.closed-notification {
  text-align: center;
  background: #fee2e2;
  border: 2px solid #fecaca;
  border-radius: 16px;
  padding: 40px 20px;
  margin: 20px 0;
  animation: fadeInUp 0.6s ease;
}

.closed-notification h2 {
  color: #991b1b;
  font-size: 24px;
  margin-bottom: 16px;
}

.closed-notification p {
  color: #7f1d1d;
  font-size: 16px;
  margin-bottom: 24px;
}

.btn-wa {
  background: #25d366;
  color: white;
  padding: 12px 24px;
  border-radius: 12px;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  transition: all 0.3s;
}

.btn-wa:hover {
  background: #128c7e;
  transform: translateY(-2px);
}

/* Config section for deadline */
.config-deadline {
  background: #fef3c7;
  border: 2px solid #fbbf24;
  padding: 16px;
  border-radius: 12px;
  margin-bottom: 20px;
  font-size: 14px;
}

.config-deadline strong {
  color: #92400e;
}

/* Password field styles */
.password-field {
  margin-top: 20px;
  text-align: center;
}

.password-field input {
  padding: 10px;
  border: 2px solid #fecaca;
  border-radius: 8px;
  width: 200px;
  margin-right: 10px;
}

.password-field button {
  padding: 10px 20px;
  background: #991b1b;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
}

.password-field button:hover {
  background: #7f1d1d;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}

@keyframes fadeInUp{
  from{
    opacity:0;
    transform:translateY(20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

@keyframes fadeInDown{
  from{
    opacity:0;
    transform:translateY(-20px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

@keyframes spin{
  to{transform:rotate(360deg);}
}

/* ===== RESPONSIVE ===== */
@media (min-width: 768px){
  body{
    padding:40px 20px;
  }

  .header h1{
    font-size:32px;
  }

  .card{
    padding:32px;
  }

  .piket-grid{
    grid-template-columns:1fr 1fr;
  }

  .btn-submit{
    max-width:400px;
    margin:0 auto;
    display:flex;
  }
}

@media (max-width: 640px){
  .header h1{
    font-size:24px;
  }

  .card{
    padding:20px;
  }

  .piket-section{
    padding:16px;
  }

  .radio-tabs{
    flex-direction:column;
  }
}

/* ===== UTILITY ===== */
.hidden{
  display:none !important;
}

.text-center{
  text-align:center;
}

.mt-2{
  margin-top:16px;
}

/* diagnostic box */
.diag{
  margin-top:12px;
  padding:12px;
  border-radius:8px;
  background:#fff4f4;
  border:1px solid #fecaca;
  color:#991b1b;
  font-family:monospace;
  font-size:13px;
  white-space:pre-wrap;
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üìã Input Piket Ujian Akhir Tahun</h1>
    <p>Sistem Pendataan Piket Bagian Selama Masa Ujian</p>

    <!-- debug: test API (bisa dihapus setelah selesai) -->
    <!-- <div style="margin-top:12px">
      <button onclick="testApi()" class="btn btn-secondary" style="padding:8px 12px;font-size:13px">Test API</button>
    </div> -->

    <!-- diagnostic box -->
    <div id="diag" class="diag hidden" aria-live="polite"></div>
  </div>

  <!-- Add config section for deadline (optional, for easy editing) -->
  <div class="config-deadline hidden">
    <strong>Konfigurasi Deadline:</strong> Edit DEADLINE di script untuk mengubah tanggal batas. WA Number: Edit WA_NUMBER.
  </div>

  <!-- Closed Submission Notification -->
  <div id="closedNotification" class="closed-notification hidden">
    <h2>‚è∞ Pengumpulan Piket Sudah Ditutup</h2>
    <p>Batas waktu pengumpulan piket ujian telah berakhir. Jika ada pertanyaan atau keperluan khusus, silakan hubungi panitia.</p>
    <a href="#" id="waLink" class="btn-wa" onclick="showPasswordField()" target="_blank">
      üì± Hubungi Panitia via WhatsApp
    </a>
    <div id="passwordField" class="password-field hidden">
      <p>Jika panitia memberikan kode akses, masukkan di bawah:</p>
      <input type="password" id="passwordInput" placeholder="">
      <button onclick="validatePassword()">Buka Form</button>
    </div>
  </div>

  <!-- LOADING INITIAL -->
  <div id="initialLoading" class="loading-overlay hidden">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>Memuat data...</p>
    </div>
  </div>

  <!-- FORM CONTENT -->
  <div id="formContent" class="hidden">
    
    <!-- PILIH TIPE -->
    <div class="card">
      <div class="card-title">Tipe Piket</div>
      <div class="radio-tabs">
        <div class="radio-tab">
          <input type="radio" id="tipeKamar" name="tipe" value="kamar" checked onchange="tipeChanged()">
          <label for="tipeKamar">
            üè† Kamar Bagian
          </label>
        </div>
        <div class="radio-tab">
          <input type="radio" id="tipeKepanitiaan" name="tipe" value="kepanitiaan" onchange="tipeChanged()">
          <label for="tipeKepanitiaan">
            üë• Kepanitiaan
          </label>
        </div>
      </div>
    </div>

    <!-- KAMAR BAGIAN -->
    <div class="card" id="cardKamar">
      <div class="card-title">Kamar Bagian</div>
      <div class="form-group">
        <label for="kamar">Pilih Kamar <span class="required">*</span></label>
        <select id="kamar" onchange="kamarDipilih()">
          <option value="">-- Pilih Kamar Bagian --</option>
        </select>
      </div>
    </div>

    <!-- KEPANITIAAN -->
    <div class="card hidden" id="cardKepanitiaan">
      <div class="card-title">Kepanitiaan</div>
      <div class="alert alert-info">
        ‚ÑπÔ∏è Mode kepanitiaan: Semua guru bisa dipilih tanpa batasan kamar
      </div>
      <div class="form-group">
        <label for="namaKepanitiaan">Nama Kepanitiaan <span class="required">*</span></label>
        <input type="text" id="namaKepanitiaan" placeholder="Contoh: Acara peringatan 100 tahun dll">
      </div>
    </div>

    <!-- PIKET UJIAN -->
    <div class="card">
      <div class="card-title">Daftar Piket Ujian</div>
      
      <div class="piket-grid">
        <!-- SYAFAHI -->
        <div class="piket-section">
          <div class="piket-section-header">
            <h3>üó£Ô∏è Ujian Syafahi</h3>
            <span class="badge" id="badgeSyafahi">0</span>
          </div>
          <div id="syafahi" class="guru-list"></div>
          <button class="btn btn-secondary btn-add" onclick="tambahGuru('syafahi')">
            + Tambah Piket
          </button>
        </div>

        <!-- TAHRIRI -->
        <div class="piket-section">
          <div class="piket-section-header">
            <h3>‚úçÔ∏è Ujian Tahriri</h3>
            <span class="badge" id="badgeTahriri">0</span>
          </div>
          <div id="tahriri" class="guru-list"></div>
          <button class="btn btn-secondary btn-add" onclick="tambahGuru('tahriri')">
            + Tambah Piket
          </button>
        </div>
      </div>
    </div>

    <!-- ALASAN (untuk kamar TIDAK piket) -->
    <div class="card hidden" id="boxAlasan">
      <div class="card-title">Alasan</div>
      <div class="alert alert-warning">
        ‚ö†Ô∏è Kamar ini ditandai TIDAK ADA piket. Mohon isi alasan.</br>
        NB: Harus dengan persetujuan Bapak Direktur dan sudah menyerahkan surat izin tertulis kepada panitia.
      </div>
      <div class="form-group">
        <label for="alasan">Alasan/Keterangan <span class="required">*</span></label>
        <textarea id="alasan" placeholder="Jelaskan detail acara/kegiatan"></textarea>
      </div>
    </div>

    <!-- SUBMIT -->
    <button class="btn btn-primary btn-submit" onclick="submitData()">
      ‚úì SUBMIT DATA
    </button>

  </div>
</div>

<!-- LOADING SUBMIT -->
<div id="submitLoading" class="loading-overlay hidden">
  <div class="loading-content">
    <div class="spinner"></div>
    <p>Mengirim data...</p>
  </div>
</div>

<script>
// ===============================
// CONFIG (FIXED API URL)
// ===============================
const API_URL = "https://script.google.com/macros/s/AKfycbzNIg35oMMpwa3jFlMMu3eowiQjyOcLLqFA_x2-D27bzl4irjE3N1xiq0hLCuvDLWdeAw/exec";

// Add deadline and WA number
const DEADLINE = new Date('2025-12-19T23:59:59'); // Set deadline date here (YYYY-MM-DDTHH:MM:SS)
const WA_NUMBER = '6282332914996'; // Replace with actual WhatsApp number (without +)
const WA_MESSAGE = encodeURIComponent('Assalamualaikum Wr. Wb Panitia, saya ingin menanyakan tentang pengumpulan piket ujian. Terima kasih.');
const PASSWORD_KEY = 'GONTOR1926'; // The access key

// Data
let semuaGuru = [];
let semuaKamar = [];
let kamarAktif = '';
let statusKamar = '';
let tipeAktif = 'kamar';
let dataLoaded = false;
// ===============================
// INIT
// ===============================
window.addEventListener('DOMContentLoaded', () => {
  const now = Date.now();
  const deadlineTime = DEADLINE.getTime();
  const hasSubmitted = localStorage.getItem('piketSubmitted') === 'true';

  if (now > deadlineTime && !hasSubmitted) {
    // Show closed notification
    document.getElementById('closedNotification').classList.remove('hidden');
    document.getElementById('waLink').href = `https://wa.me/${WA_NUMBER}?text=${WA_MESSAGE}`;
    document.getElementById('initialLoading').classList.add('hidden');
    document.getElementById('formContent').classList.add('hidden');
  } else if (hasSubmitted) {
    // Already submitted, keep closed
    document.getElementById('closedNotification').classList.remove('hidden');
    document.getElementById('passwordField').classList.add('hidden');
    document.getElementById('waLink').style.display = 'none';
    document.getElementById('closedNotification').innerHTML += '<p style="color: #7f1d1d; margin-top: 10px;">Form sudah diisi dan dikirim. Tidak dapat dibuka lagi.</p>';
  } else {
    // Load form as usual
    loadInitialData();
  }

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.select-wrapper')) {
      document.querySelectorAll('.select-dropdown').forEach(d => {
        d.classList.remove('show');
      });
    }
  });
});

// Show password field on WA button click
function showPasswordField() {
  document.getElementById('passwordField').classList.remove('hidden');
}

// Validate password
function validatePassword() {
  const input = document.getElementById('passwordInput').value;
  if (input === PASSWORD_KEY) {
    // Open form
    document.getElementById('closedNotification').classList.add('hidden');
    loadInitialData();
  } else {
    alert('Kode akses salah. Silakan hubungi panitia untuk mendapatkan kode.');
  }
}

// ===============================
// API Call Helper
// ===============================
async function callApi(action, data = {}) {
  // GET read endpoints via JSONP (existing)
  if (action === 'getGuru' || action === 'getKamar') {
    return new Promise((resolve, reject) => {
      const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
      const timeoutMs = 12000;
      let timer = null;
      let script = null;

      window[cbName] = (resp) => {
        clearTimeout(timer);
        try {
          if (!resp) throw new Error('No response');
          if (!resp.success) throw new Error(resp.error || 'API returned unsuccessful response');
          clearDiag();
          resolve(resp.data);
        } catch (err) {
          showDiag(err.message);
          reject(err);
        } finally {
          try { delete window[cbName]; } catch(e){}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }
      };

      const url = API_URL + '?action=' + encodeURIComponent(action) + '&callback=' + cbName;
      script = document.createElement('script');
      script.src = url;
      script.async = true;

      script.onerror = () => {
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        if (script && script.parentNode) script.parentNode.removeChild(script);

        const msg =
          'JSONP load error.\n\nKemungkinan penyebab:\n' +
          '‚Ä¢ Apps Script belum di-deploy sebagai "Anyone, even anonymous".\n' +
          '‚Ä¢ API_URL salah atau deploy URL berubah.\n' +
          '‚Ä¢ Browser/extension memblokir skrip pihak ketiga (adblock/privacy).\n\n' +
          'Buka link test di browser ini:\n' + url;
        showDiag(msg, url);
        reject(new Error(msg));
      };

      document.head.appendChild(script);

      timer = setTimeout(() => {
        try { delete window[cbName]; } catch(e){}
        if (script && script.parentNode) script.parentNode.removeChild(script);
        const msg = 'JSONP request timed out. Cek koneksi, CORS/deploy atau extension yang memblokir.\nTest URL: ' + url;
        showDiag(msg, url);
        reject(new Error(msg));
      }, timeoutMs);
    });
  }

  // For submitPiket: try POST, on network/CORS error fallback to JSONP submit
  if (action === 'submitPiket') {
    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action, data })
      });

      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} ${res.statusText} ${text}`);
      }

      const json = await res.json().catch(() => null);
      if (!json) throw new Error('Invalid JSON response from API');
      if (!json.success) throw new Error(json.error || 'API returned unsuccessful response');

      return json.data;
    } catch (err) {
      // Fallback to JSONP submit (encode payload in query)
      return new Promise((resolve, reject) => {
        const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        const timeoutMs = 15000;
        let timer = null;

        window[cbName] = (resp) => {
          clearTimeout(timer);
          try {
            if (!resp) throw new Error('No response');
            if (!resp.success) throw new Error(resp.error || 'API returned unsuccessful response');
            resolve(resp.data);
          } catch (e) {
            reject(e);
          } finally {
            delete window[cbName];
            if (script && script.parentNode) script.parentNode.removeChild(script);
          }
        };

        const payloadStr = encodeURIComponent(JSON.stringify(data));
        const url = API_URL + '?action=submitPiket&data=' + payloadStr + '&callback=' + cbName;
        const script = document.createElement('script');
        script.src = url;
        script.async = true;
        script.onerror = () => {
          clearTimeout(timer);
          delete window[cbName];
          if (script.parentNode) script.parentNode.removeChild(script);
          reject(new Error('JSONP submit failed'));
        };
        document.head.appendChild(script);

        timer = setTimeout(() => {
          if (window[cbName]) {
            delete window[cbName];
            if (script.parentNode) script.parentNode.removeChild(script);
            reject(new Error('JSONP submit timed out'));
          }
        }, timeoutMs);
      });
    }
  }

  // For any other action use POST (same as before)
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action, data })
    });

    if (!res.ok) {
      const text = await res.text().catch(() => '');
      throw new Error(`HTTP ${res.status} ${res.statusText} ${text}`);
    }

    const json = await res.json().catch(() => null);
    if (!json) throw new Error('Invalid JSON response from API');
    if (!json.success) throw new Error(json.error || 'API returned unsuccessful response');

    return json.data;
  } catch (err) {
    throw new Error('callApi error: ' + (err.message || err));
  }
}

// ===============================
// Load Initial Data
// ===============================
async function loadInitialData() {
  document.getElementById('initialLoading').classList.remove('hidden');
  clearDiag();
  try {
    // Load Guru & Kamar secara parallel
    const [guruData, kamarData] = await Promise.all([
      callApi('getGuru'),
      callApi('getKamar')
    ]);
    
    semuaGuru = guruData;
    semuaKamar = kamarData;
    
    // Populate kamar select
    const select = document.getElementById('kamar');
    select.innerHTML = '<option value="">-- Pilih Kamar Bagian --</option>' +
      kamarData.map(k => 
        `<option value="${k.kamar}" data-status="${k.status}">${k.kamar} ${k.status === 'TIDAK' ? '(Tidak Ada Piket)' : ''}</option>`
      ).join('');
    
    dataLoaded = true;
    document.getElementById('initialLoading').classList.add('hidden');
    document.getElementById('formContent').classList.remove('hidden');
    
  } catch (error) {
    document.getElementById('initialLoading').classList.add('hidden');
    showDiag(error.message, API_URL + '?action=getGuru&callback=cb_test');
    const retry = confirm('‚ùå Gagal memuat data:\n' + error.message + '\n\nCoba lagi?');
    if (retry) {
      loadInitialData();
    } else {
      // Reset config
      localStorage.removeItem('apiUrl');
      location.reload();
    }
  }
}

// ===============================
// Tipe Changed
// ===============================
function tipeChanged() {
  const tipe = document.querySelector('input[name="tipe"]:checked').value;
  tipeAktif = tipe;

  const cardKamar = document.getElementById('cardKamar');
  const cardKepanitiaan = document.getElementById('cardKepanitiaan');
  const boxAlasan = document.getElementById('boxAlasan');

  if (tipe === 'kamar') {
    cardKamar.classList.remove('hidden');
    cardKepanitiaan.classList.add('hidden');
    kamarAktif = '';
    statusKamar = '';
  } else {
    cardKamar.classList.add('hidden');
    cardKepanitiaan.classList.remove('hidden');
    boxAlasan.classList.add('hidden');
    kamarAktif = 'KEPANITIAAN';
    statusKamar = 'ADA';
  }

  resetGuruList();
}

// ===============================
// Kamar Dipilih
// ===============================
function kamarDipilih() {
  const opt = document.querySelector('#kamar option:checked');
  kamarAktif = opt.value;
  statusKamar = opt.dataset.status || '';

  resetGuruList();

  const boxAlasan = document.getElementById('boxAlasan');
  const alasanInput = document.getElementById('alasan');

  if (statusKamar === 'TIDAK') {
    boxAlasan.classList.remove('hidden');
    alasanInput.required = true;
  } else {
    boxAlasan.classList.add('hidden');
    alasanInput.required = false;
    alasanInput.value = '';
  }
}

function resetGuruList() {
  document.getElementById('syafahi').innerHTML = '';
  document.getElementById('tahriri').innerHTML = '';
  updateBadge('syafahi');
  updateBadge('tahriri');
}

// ===============================
// Searchable Select
// ===============================
function createSearchableSelect(guruList, onSelect) {
  const wrapper = document.createElement('div');
  wrapper.className = 'select-wrapper';

  const searchDiv = document.createElement('div');
  searchDiv.className = 'select-search';

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'üîç Cari nama guru...';
  input.autocomplete = 'off';

  const icon = document.createElement('span');
  icon.className = 'select-search-icon';
  icon.textContent = '‚ñº';

  const dropdown = document.createElement('div');
  dropdown.className = 'select-dropdown';

  // Render options
  function renderOptions(filter = '') {
    const filtered = guruList.filter(g => {
      const text = `${g.rank} ${g.nama} ${g.kamar}`.toLowerCase();
      return text.includes(filter.toLowerCase());
    });

    if (filtered.length === 0) {
      dropdown.innerHTML = '<div class="select-option-empty">Tidak ada hasil</div>';
      return;
    }

    dropdown.innerHTML = filtered.map(g => 
      `<div class="select-option" data-rank="${g.rank}" data-nama="${g.nama}" data-kamar="${g.kamar}">
        <strong>${g.rank} - ${g.nama}</strong>
        <div style="font-size:12px;color:var(--text-light);margin-top:2px">${g.kamar}</div>
      </div>`
    ).join('');

    // Add click handlers
    dropdown.querySelectorAll('.select-option').forEach(opt => {
      opt.onclick = () => {
        const rank = opt.dataset.rank;
        const nama = opt.dataset.nama;
        const kamar = opt.dataset.kamar;
        
        input.value = `${rank} - ${nama}`;
        input.dataset.rank = rank;
        input.dataset.nama = nama;
        input.dataset.kamar = kamar;
        
        dropdown.classList.remove('show');
        
        if (onSelect) onSelect({ rank, nama, kamar });
      };
    });
  }

  // Input events
  input.onfocus = () => {
    renderOptions(input.value);
    dropdown.classList.add('show');
  };

  input.oninput = () => {
    renderOptions(input.value);
    if (!dropdown.classList.contains('show')) {
      dropdown.classList.add('show');
    }
  };

  searchDiv.appendChild(input);
  searchDiv.appendChild(icon);
  wrapper.appendChild(searchDiv);
  wrapper.appendChild(dropdown);

  return { wrapper, input };
}

// ===============================
// Tambah Guru
// ===============================
function tambahGuru(jenis) {
  if (!dataLoaded) {
    alert('‚ö†Ô∏è Data masih dimuat, mohon tunggu sebentar');
    return;
  }

  let guruList = [];

  if (tipeAktif === 'kepanitiaan') {
    guruList = semuaGuru;
  } else {
    if (!kamarAktif) {
      alert('‚ö†Ô∏è Silakan pilih kamar bagian terlebih dahulu');
      return;
    }
    guruList = semuaGuru.filter(g => g.kamar === kamarAktif);
    
    if (guruList.length === 0) {
      alert('‚ö†Ô∏è Tidak ada guru terdaftar di kamar ini');
      return;
    }
  }

  const container = document.getElementById(jenis);
  const itemDiv = document.createElement('div');
  itemDiv.className = 'guru-item';

  const { wrapper, input } = createSearchableSelect(guruList, () => {
    updateBadge(jenis);
  });

  const btnRemove = document.createElement('button');
  btnRemove.className = 'btn btn-remove';
  btnRemove.textContent = '√ó';
  btnRemove.onclick = () => {
    itemDiv.remove();
    updateBadge(jenis);
  };

  itemDiv.appendChild(wrapper);
  itemDiv.appendChild(btnRemove);
  container.appendChild(itemDiv);

  setTimeout(() => input.focus(), 100);

  updateBadge(jenis);
}

// ===============================
// Update Badge Counter
// ===============================
function updateBadge(jenis) {
  const inputs = document.querySelectorAll(`#${jenis} .select-search input`);
  const filled = Array.from(inputs).filter(i => i.dataset.rank).length;
  document.getElementById(`badge${jenis.charAt(0).toUpperCase() + jenis.slice(1)}`).textContent = filled;
}

// ===============================
// Submit Data
// ===============================
async function submitData() {

  // ===== VALIDASI TIPE =====
  if (tipeAktif === 'kamar' && !kamarAktif) {
    alert('‚ö†Ô∏è Silakan pilih kamar bagian');
    return;
  }

  if (tipeAktif === 'kepanitiaan') {
    const namaKepanitiaan = document.getElementById('namaKepanitiaan').value.trim();
    if (!namaKepanitiaan) {
      alert('‚ö†Ô∏è Nama kepanitiaan harus diisi');
      return;
    }
    kamarAktif = `KEPANITIAAN: ${namaKepanitiaan}`;
  }

  // ===== KUMPULKAN DATA GURU =====
  const list = [];

  // gunakan set terpisah per jenis agar guru boleh muncul di kedua jenis,
  // tapi tidak boleh didobel dalam satu jenis
  const setSyafahi = new Set();
  const setTahriri = new Set();

  // --- SYAFAHI ---
  let duplicate = false;
  document.querySelectorAll('#syafahi .select-search input').forEach(input => {
    if (duplicate) return;
    if (input.dataset.rank && input.dataset.nama) {
      const key = `${input.dataset.rank}|${input.dataset.nama}`;
      if (setSyafahi.has(key)) {
        alert(`‚ö†Ô∏è Guru ${input.dataset.nama} sudah dipilih lebih dari sekali di Syafahi`);
        duplicate = true;
        return;
      }
      setSyafahi.add(key);
      list.push({
        jenis: 'Syafahi',
        rank: input.dataset.rank,
        nama: input.dataset.nama
      });
    }
  });
  if (duplicate) return;

  // --- TAHRIRI ---
  document.querySelectorAll('#tahriri .select-search input').forEach(input => {
    if (duplicate) return;
    if (input.dataset.rank && input.dataset.nama) {
      const key = `${input.dataset.rank}|${input.dataset.nama}`;
      if (setTahriri.has(key)) {
        alert(`‚ö†Ô∏è Guru ${input.dataset.nama} sudah dipilih lebih dari sekali di Tahriri`);
        duplicate = true;
        return;
      }
      setTahriri.add(key);
      list.push({
        jenis: 'Tahriri',
        rank: input.dataset.rank,
        nama: input.dataset.nama
      });
    }
  });
  if (duplicate) return;

  // ===== VALIDASI MINIMAL =====
  if (list.length === 0) {
    alert('‚ö†Ô∏è Minimal pilih satu Piket Ujian');
    return;
  }

  // ===== VALIDASI ALASAN =====
  const alasan = document.getElementById('alasan').value.trim();
  if (statusKamar === 'TIDAK' && !alasan) {
    alert('‚ö†Ô∏è Alasan wajib diisi untuk kamar yang tidak ada piket');
    return;
  }

  // ===== KONFIRMASI =====
  const msg =
    `Apakah data sudah benar?\n\n` +
    `${tipeAktif === 'kepanitiaan' ? 'Kepanitiaan' : 'Kamar'}: ${kamarAktif}\n` +
    `Jumlah Piket: ${list.length}\n\n` +
    list.map(g => `‚Ä¢ ${g.jenis}: ${g.rank} - ${g.nama}`).join('\n');

  if (!confirm(msg)) return;

  // ===== SUBMIT =====
  document.getElementById('submitLoading').classList.remove('hidden');

  try {
    await callApi('submitPiket', {
      kamar: kamarAktif,
      tipe: tipeAktif,
      alasan: alasan || '-',
      list: list
    });

    // Set flag to prevent reopening
    localStorage.setItem('piketSubmitted', 'true');

    document.getElementById('submitLoading').classList.add('hidden');
    alert('‚úÖ Data berhasil terkirim! Form telah ditutup permanen.');
    location.reload();

  } catch (error) {
    document.getElementById('submitLoading').classList.add('hidden');
    alert('‚ùå Gagal mengirim data: ' + error.message);
  }
}

function testApi() {
  const url = API_URL + '?action=getGuru&callback=cb_test';
  window.open(url, '_blank');
  showDiag('Membuka URL tes, periksa apakah hasil berupa cb_test(...).', url);
}

/* small helper to show diagnostic info to user (and console) */
function showDiag(message, url) {
  const diag = document.getElementById('diag');
  const ua = navigator.userAgent || 'unknown UA';
  let text = '‚ö†Ô∏è Gagal memuat data:\n' + message + '\n\nUser-Agent:\n' + ua;
  if (url) text += '\n\nTest URL:\n' + url;
  diag.textContent = text;
  diag.classList.remove('hidden');
  console.warn('Diag:', text);
}
function clearDiag() {
  const diag = document.getElementById('diag');
  diag.classList.add('hidden');
  diag.textContent = '';
}
</script>
</body>
</html>